<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Ostia data in the Spilhaus projection &#8212; Philip&#39;s Posters</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinxdoc.css?v=d59dc883" />
    <script src="../../_static/documentation_options.js?v=8d563738"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Observations coverage (ISPD4.7)" href="../ISPD4.7/index.html" />
    <link rel="prev" title="Eye-candy: Philip’s posters" href="../../index.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../ISPD4.7/index.html" title="Observations coverage (ISPD4.7)"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../../index.html" title="Eye-candy: Philip’s posters"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Posters</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Ostia data in the Spilhaus projection</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="ostia-data-in-the-spilhaus-projection">
<h1>Ostia data in the Spilhaus projection<a class="headerlink" href="#ostia-data-in-the-spilhaus-projection" title="Link to this heading">¶</a></h1>
<figure class="align-center" style="width: 65%">
<a class="reference external image-reference" href="https://s3-eu-west-1.amazonaws.com/philip.brohan.org.big-files/Posters/Spilhaus/spilhaus_ostia_meto.pdf"><img alt="../../_images/spilhaus_ostia_meto.png" src="../../_images/spilhaus_ostia_meto.png" style="width: 65%;" /></a>
</figure>
<p>The <a class="reference external" href="https://storymaps.arcgis.com/stories/756bcae18d304a1eac140f19f4d5cb3d">Spilhaus projection</a> is an ocean-centred map projection which would work nicely for displaying global marine data such as sea-surface temperatures (SST). I try, however, not to use custom projections - as far as possible I just use the <a class="reference external" href="https://en.wikipedia.org/wiki/Equirectangular_projection">equirectangular projection</a>: It’s easy to use with the software I already have, and by suitable choice of pole location, central meridan, and scale, it’s flexible in its output.</p>
<p>So, can we find an equirectangular approximation to the Spilhaus projection? I picked:</p>
<ul class="simple">
<li><p>pole_longitude=113.0</p></li>
<li><p>pole_latitude=32.0</p></li>
<li><p>central_rotated_longitude=193.0</p></li>
<li><p>an extended longitude range of -202 W to 180E</p></li>
</ul>
<p>Combining this with selective masking of some bits of ocean shown twice (because of the extended longitude), gave the result above. The plot is of SST from the Met Office operational model (effectively of <a class="reference external" href="http://ghrsst-pp.metoffice.com/ostia/">OSTIA</a>).</p>
<ul class="simple">
<li><p><a class="reference external" href="https://s3-eu-west-1.amazonaws.com/philip.brohan.org.big-files/Posters/Spilhaus/spilhaus_ostia_meto.pdf">Full resolution PDF (10Mb, printable)</a></p></li>
</ul>
<section id="code-to-make-the-poster">
<h2>Code to make the poster<a class="headerlink" href="#code-to-make-the-poster" title="Link to this heading">¶</a></h2>
<p>Script to download the selected data from the operational MASS archive at the Met Office:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>

<span class="c1"># Retrieve surface weather variables from the global analysis</span>
<span class="c1">#  for one day.</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">tempfile</span> <span class="kn">import</span> <span class="n">NamedTemporaryFile</span>
<span class="kn">import</span> <span class="nn">subprocess</span>

<span class="kn">import</span> <span class="nn">argparse</span>
<span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--year&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Year&quot;</span><span class="p">,</span>
                    <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--month&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Integer month&quot;</span><span class="p">,</span>
                    <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--day&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Day of month&quot;</span><span class="p">,</span>
                    <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--opdir&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Directory for output files&quot;</span><span class="p">,</span>
                    <span class="n">default</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/opfc/glm&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;SCRATCH&#39;</span><span class="p">))</span>
<span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
<span class="n">opdir</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/</span><span class="si">%04d</span><span class="s2">/</span><span class="si">%02d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">opdir</span><span class="p">,</span><span class="n">args</span><span class="o">.</span><span class="n">year</span><span class="p">,</span><span class="n">args</span><span class="o">.</span><span class="n">month</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">opdir</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">opdir</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%04d</span><span class="s2">-</span><span class="si">%02d</span><span class="s2">-</span><span class="si">%02d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">year</span><span class="p">,</span><span class="n">args</span><span class="o">.</span><span class="n">month</span><span class="p">,</span><span class="n">args</span><span class="o">.</span><span class="n">day</span><span class="p">))</span>

<span class="c1"># Mass directory to use</span>
<span class="n">mass_dir</span><span class="o">=</span><span class="s2">&quot;moose:/opfc/atm/global/prods/</span><span class="si">%04d</span><span class="s2">.pp&quot;</span> <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">year</span>

<span class="c1"># Files to retrieve from</span>
<span class="n">flist</span><span class="o">=</span><span class="p">[]</span>
<span class="k">for</span> <span class="n">hour</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">18</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">fcst</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">6</span><span class="p">):</span>
        <span class="n">flist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;prods_op_gl-mn_</span><span class="si">%04d%02d%02d</span><span class="s2">_</span><span class="si">%02d</span><span class="s2">_</span><span class="si">%03d</span><span class="s2">.pp&quot;</span> <span class="o">%</span> <span class="p">(</span>
                       <span class="n">args</span><span class="o">.</span><span class="n">year</span><span class="p">,</span><span class="n">args</span><span class="o">.</span><span class="n">month</span><span class="p">,</span><span class="n">args</span><span class="o">.</span><span class="n">day</span><span class="p">,</span><span class="n">hour</span><span class="p">,</span><span class="n">fcst</span><span class="p">))</span>
        <span class="n">flist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;prods_op_gl-mn_</span><span class="si">%04d%02d%02d</span><span class="s2">_</span><span class="si">%02d</span><span class="s2">_</span><span class="si">%03d</span><span class="s2">.calc.pp&quot;</span> <span class="o">%</span> <span class="p">(</span>
                       <span class="n">args</span><span class="o">.</span><span class="n">year</span><span class="p">,</span><span class="n">args</span><span class="o">.</span><span class="n">month</span><span class="p">,</span><span class="n">args</span><span class="o">.</span><span class="n">day</span><span class="p">,</span><span class="n">hour</span><span class="p">,</span><span class="n">fcst</span><span class="p">))</span>
        <span class="n">flist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;prods_op_gl-up_</span><span class="si">%04d%02d%02d</span><span class="s2">_</span><span class="si">%02d</span><span class="s2">_</span><span class="si">%03d</span><span class="s2">.calc.pp&quot;</span> <span class="o">%</span> <span class="p">(</span>
                       <span class="n">args</span><span class="o">.</span><span class="n">year</span><span class="p">,</span><span class="n">args</span><span class="o">.</span><span class="n">month</span><span class="p">,</span><span class="n">args</span><span class="o">.</span><span class="n">day</span><span class="p">,</span><span class="n">hour</span><span class="p">,</span><span class="n">fcst</span><span class="p">))</span>

<span class="c1"># Create the query file</span>
<span class="n">qfile</span><span class="o">=</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w+&#39;</span><span class="p">,</span><span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">qfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;begin_global</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">qfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   pp_file = (&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">ppfl</span> <span class="ow">in</span> <span class="n">flist</span><span class="p">:</span>
    <span class="n">qfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ppfl</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ppfl</span> <span class="o">!=</span> <span class="n">flist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">qfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">qfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">qfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;end_global</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">qfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;begin</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">qfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;    stash = (16222,24,3236,31,3225,3226)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">qfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;    lbproc = 0</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">qfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;end</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">qfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;begin</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">qfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;    stash = (5216,5206,5205,4203,4204)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">qfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;    lbproc = 128</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">qfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;end</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">qfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c1"># Run the query</span>
<span class="n">opfile</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/</span><span class="si">%02d</span><span class="s2">.pp&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">opdir</span><span class="p">,</span><span class="n">args</span><span class="o">.</span><span class="n">day</span><span class="p">)</span>
<span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s2">&quot;moo select -C </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">qfile</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="n">mass_dir</span><span class="p">,</span><span class="n">opfile</span><span class="p">),</span>
                 <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">qfile</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</pre></div>
</div>
<p>Script to download the fixed land mask and orography fields:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>

<span class="c1"># Download boundary conditions.</span>
<span class="c1"># Store it on $SCRATCH</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">urllib.request</span>

<span class="c1"># Land mask</span>
<span class="n">srce</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;https://s3-eu-west-1.amazonaws.com/&quot;</span><span class="o">+</span>
      <span class="s2">&quot;philip.brohan.org.big-files/fixed_fields/&quot;</span><span class="o">+</span>
      <span class="s2">&quot;land_mask/opfc_global_2019.nc&quot;</span><span class="p">)</span>
<span class="n">dst</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/fixed_fields/land_mask/opfc_global_2019.nc&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;SCRATCH&#39;</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dst</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">dst</span><span class="p">)):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">dst</span><span class="p">))</span>
    <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">srce</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span>
<span class="c1"># Orography</span>
<span class="n">srce</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;https://s3-eu-west-1.amazonaws.com/&quot;</span><span class="o">+</span>
      <span class="s2">&quot;philip.brohan.org.big-files/fixed_fields/&quot;</span><span class="o">+</span>
      <span class="s2">&quot;orography/opfc_global_2019.nc&quot;</span><span class="p">)</span>
<span class="n">dst</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/fixed_fields/orography/opfc_global_2019.nc&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;SCRATCH&#39;</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dst</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">dst</span><span class="p">)):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">dst</span><span class="p">))</span>
    <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">srce</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span>

</pre></div>
</div>
<p>Script to plot the poster:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>

<span class="c1"># Ocean-centred projection. Equirectangular, but inspired by Spilhaus.</span>
<span class="c1"># Meto global data.</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">IRData.opfc</span> <span class="k">as</span> <span class="nn">opfc</span>
<span class="kn">import</span> <span class="nn">Meteorographica</span> <span class="k">as</span> <span class="nn">mg</span>
<span class="kn">import</span> <span class="nn">iris</span>
<span class="kn">import</span> <span class="nn">numpy</span>

<span class="n">dte</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2019</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="kn">from</span> <span class="nn">matplotlib.backends.backend_agg</span> <span class="kn">import</span> <span class="n">FigureCanvasAgg</span> <span class="k">as</span> <span class="n">FigureCanvas</span>
<span class="kn">from</span> <span class="nn">matplotlib.figure</span> <span class="kn">import</span> <span class="n">Figure</span>
<span class="kn">from</span> <span class="nn">matplotlib.lines</span> <span class="kn">import</span> <span class="n">Line2D</span>
<span class="kn">import</span> <span class="nn">cartopy</span>
<span class="kn">import</span> <span class="nn">cartopy.crs</span> <span class="k">as</span> <span class="nn">ccrs</span>

<span class="kn">from</span> <span class="nn">pandas</span> <span class="kn">import</span> <span class="n">qcut</span>

<span class="c1"># Scale down the latitudinal variation in temperature</span>
<span class="k">def</span> <span class="nf">damp_lat</span><span class="p">(</span><span class="n">sst</span><span class="p">,</span><span class="n">factor</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
    <span class="n">s</span><span class="o">=</span><span class="n">sst</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">mt</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">sst</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">lat_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">lmt</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sst</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">lat_i</span><span class="p">,:])</span>
        <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">lmt</span><span class="p">):</span>
            <span class="n">sst</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">lat_i</span><span class="p">,:]</span> <span class="o">-=</span> <span class="p">(</span><span class="n">lmt</span><span class="o">-</span><span class="n">mt</span><span class="p">)</span><span class="o">*</span><span class="n">factor</span>
    <span class="k">return</span><span class="p">(</span><span class="n">sst</span><span class="p">)</span>

<span class="c1"># Load the Meto SST</span>
<span class="n">sst</span><span class="o">=</span><span class="n">opfc</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;tsurf&#39;</span><span class="p">,</span><span class="n">dte</span><span class="p">,</span><span class="n">model</span><span class="o">=</span><span class="s1">&#39;global&#39;</span><span class="p">)</span>
<span class="c1"># And the sea-ice</span>
<span class="n">icec</span><span class="o">=</span><span class="n">opfc</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;icec&#39;</span><span class="p">,</span><span class="n">dte</span><span class="p">,</span><span class="n">model</span><span class="o">=</span><span class="s1">&#39;global&#39;</span><span class="p">)</span>
<span class="c1"># And the orography</span>
<span class="n">orog</span><span class="o">=</span><span class="n">iris</span><span class="o">.</span><span class="n">load_cube</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/fixed_fields/orography/opfc_global_2019.nc&quot;</span> <span class="o">%</span> 
                                                  <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;SCRATCH&#39;</span><span class="p">))</span>
<span class="c1"># And the land-sea mask</span>
<span class="n">mask</span><span class="o">=</span><span class="n">iris</span><span class="o">.</span><span class="n">load_cube</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/fixed_fields/land_mask/opfc_global_2019.nc&quot;</span> <span class="o">%</span> 
                                                  <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;SCRATCH&#39;</span><span class="p">))</span>

<span class="c1"># Apply the LS mask to turn tsurf into SST</span>
<span class="n">sst</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">mask</span><span class="o">.</span><span class="n">data</span><span class="o">&gt;=</span><span class="mf">0.5</span><span class="p">]</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">nan</span>
<span class="n">sst</span><span class="o">.</span><span class="n">data</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sst</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                        <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="o">.</span><span class="n">data</span><span class="o">&gt;</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">sst</span><span class="o">=</span><span class="n">damp_lat</span><span class="p">(</span><span class="n">sst</span><span class="p">,</span><span class="n">factor</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>

<span class="c1"># Define the figure (page size, background color, resolution, ...</span>
<span class="n">fig</span><span class="o">=</span><span class="n">Figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">46.8</span><span class="p">,</span><span class="mf">23.4</span><span class="p">),</span>              <span class="c1"># Width, Height (inches)</span>
           <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
           <span class="n">facecolor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
           <span class="n">edgecolor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
           <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
           <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>                <span class="c1"># Don&#39;t draw a frame</span>
           <span class="n">subplotpars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
           <span class="n">tight_layout</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">set_frameon</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span> 
<span class="c1"># Attach a canvas</span>
<span class="n">canvas</span><span class="o">=</span><span class="n">FigureCanvas</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

<span class="c1"># Choose a pole rotation that approximates the</span>
<span class="c1"># Spilhaus projection - bordered by land, ocean in the middle.</span>
<span class="n">projection</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">RotatedPole</span><span class="p">(</span><span class="n">pole_longitude</span><span class="o">=</span><span class="mf">113.0</span><span class="p">,</span>
                                <span class="n">pole_latitude</span><span class="o">=</span><span class="mf">32.0</span><span class="p">,</span>
                                <span class="n">central_rotated_longitude</span><span class="o">=</span><span class="mf">193.0</span><span class="p">)</span>

<span class="c1"># To plot the fields we are going to re-grid them onto a plot cube</span>
<span class="c1">#  with the pole rotated to a position that approximates the</span>
<span class="c1">#  Spilhaus projection - bordered by land, ocean in the middle.</span>
<span class="k">def</span> <span class="nf">plot_cube</span><span class="p">(</span><span class="n">resolution</span><span class="p">):</span>

    <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">202</span><span class="p">,</span><span class="mi">180</span><span class="p">,</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span><span class="mi">90</span><span class="p">]</span>
    <span class="n">pole_latitude</span><span class="o">=</span><span class="mf">32.0</span>
    <span class="n">pole_longitude</span><span class="o">=</span><span class="mf">113.0</span>
    <span class="n">npg_longitude</span><span class="o">=</span><span class="mf">193.0</span>

    <span class="n">cs</span><span class="o">=</span><span class="n">iris</span><span class="o">.</span><span class="n">coord_systems</span><span class="o">.</span><span class="n">RotatedGeogCS</span><span class="p">(</span><span class="n">pole_latitude</span><span class="p">,</span>
                                        <span class="n">pole_longitude</span><span class="p">,</span>
                                        <span class="n">npg_longitude</span><span class="p">)</span>
    <span class="n">lat_values</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">extent</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">extent</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="n">resolution</span><span class="p">,</span><span class="n">resolution</span><span class="p">)</span>
    <span class="n">latitude</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">DimCoord</span><span class="p">(</span><span class="n">lat_values</span><span class="p">,</span>
                                    <span class="n">standard_name</span><span class="o">=</span><span class="s1">&#39;latitude&#39;</span><span class="p">,</span>
                                    <span class="n">units</span><span class="o">=</span><span class="s1">&#39;degrees_north&#39;</span><span class="p">,</span>
                                    <span class="n">coord_system</span><span class="o">=</span><span class="n">cs</span><span class="p">)</span>
    <span class="n">lon_values</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">extent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">extent</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">resolution</span><span class="p">,</span><span class="n">resolution</span><span class="p">)</span>
    <span class="n">longitude</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">DimCoord</span><span class="p">(</span><span class="n">lon_values</span><span class="p">,</span>
                                     <span class="n">standard_name</span><span class="o">=</span><span class="s1">&#39;longitude&#39;</span><span class="p">,</span>
                                     <span class="n">units</span><span class="o">=</span><span class="s1">&#39;degrees_east&#39;</span><span class="p">,</span>
                                     <span class="n">coord_system</span><span class="o">=</span><span class="n">cs</span><span class="p">)</span>
    <span class="n">dummy_data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">lat_values</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">lon_values</span><span class="p">)))</span>
    <span class="n">plot_cube</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">cube</span><span class="o">.</span><span class="n">Cube</span><span class="p">(</span><span class="n">dummy_data</span><span class="p">,</span>
                               <span class="n">dim_coords_and_dims</span><span class="o">=</span><span class="p">[(</span><span class="n">latitude</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                                                    <span class="p">(</span><span class="n">longitude</span><span class="p">,</span> <span class="mi">1</span><span class="p">)])</span>
    <span class="k">return</span> <span class="n">plot_cube</span>

<span class="n">pc</span><span class="o">=</span><span class="n">plot_cube</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>   

<span class="c1"># Mask out the duplicated SST data</span>
<span class="k">def</span> <span class="nf">strip_dups</span><span class="p">(</span><span class="n">sst</span><span class="p">,</span><span class="n">resolution</span><span class="o">=</span><span class="mf">0.25</span><span class="p">):</span>
    <span class="n">scale</span><span class="o">=</span><span class="mf">0.25</span><span class="o">/</span><span class="n">resolution</span>
    <span class="n">s</span><span class="o">=</span><span class="n">sst</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">sst</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="mi">0</span><span class="p">:(</span><span class="nb">int</span><span class="p">(</span><span class="mi">150</span><span class="o">*</span><span class="n">scale</span><span class="p">)),</span><span class="mi">0</span><span class="p">:(</span><span class="nb">int</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="n">scale</span><span class="p">))]</span><span class="o">=</span><span class="kc">True</span>
    <span class="n">sst</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mask</span><span class="p">[(</span><span class="nb">int</span><span class="p">(</span><span class="mi">150</span><span class="o">*</span><span class="n">scale</span><span class="p">)):(</span><span class="nb">int</span><span class="p">(</span><span class="mi">171</span><span class="o">*</span><span class="n">scale</span><span class="p">)),</span><span class="mi">0</span><span class="p">:(</span><span class="nb">int</span><span class="p">(</span><span class="mi">75</span><span class="o">*</span><span class="n">scale</span><span class="p">))]</span><span class="o">=</span><span class="kc">True</span>
    <span class="n">sst</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mask</span><span class="p">[(</span><span class="nb">int</span><span class="p">(</span><span class="mi">170</span><span class="o">*</span><span class="n">scale</span><span class="p">)):(</span><span class="nb">int</span><span class="p">(</span><span class="mi">190</span><span class="o">*</span><span class="n">scale</span><span class="p">)),</span><span class="mi">0</span><span class="p">:(</span><span class="nb">int</span><span class="p">(</span><span class="mi">48</span><span class="o">*</span><span class="n">scale</span><span class="p">))]</span><span class="o">=</span><span class="kc">True</span>
    <span class="n">sst</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mask</span><span class="p">[(</span><span class="nb">int</span><span class="p">(</span><span class="mi">190</span><span class="o">*</span><span class="n">scale</span><span class="p">)):(</span><span class="nb">int</span><span class="p">(</span><span class="mi">200</span><span class="o">*</span><span class="n">scale</span><span class="p">)),</span><span class="mi">0</span><span class="p">:(</span><span class="nb">int</span><span class="p">(</span><span class="mi">40</span><span class="o">*</span><span class="n">scale</span><span class="p">))]</span><span class="o">=</span><span class="kc">True</span>
    <span class="n">sst</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mask</span><span class="p">[(</span><span class="nb">int</span><span class="p">(</span><span class="mi">200</span><span class="o">*</span><span class="n">scale</span><span class="p">)):(</span><span class="nb">int</span><span class="p">(</span><span class="mi">210</span><span class="o">*</span><span class="n">scale</span><span class="p">)),</span><span class="mi">0</span><span class="p">:(</span><span class="nb">int</span><span class="p">(</span><span class="mi">30</span><span class="o">*</span><span class="n">scale</span><span class="p">))]</span><span class="o">=</span><span class="kc">True</span>
    <span class="n">sst</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mask</span><span class="p">[(</span><span class="nb">int</span><span class="p">(</span><span class="mi">210</span><span class="o">*</span><span class="n">scale</span><span class="p">)):(</span><span class="nb">int</span><span class="p">(</span><span class="mi">225</span><span class="o">*</span><span class="n">scale</span><span class="p">)),</span><span class="mi">0</span><span class="p">:(</span><span class="nb">int</span><span class="p">(</span><span class="mi">15</span><span class="o">*</span><span class="n">scale</span><span class="p">))]</span><span class="o">=</span><span class="kc">True</span>
    <span class="n">sst</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mask</span><span class="p">[(</span><span class="nb">int</span><span class="p">(</span><span class="mi">350</span><span class="o">*</span><span class="n">scale</span><span class="p">)):(</span><span class="nb">int</span><span class="p">(</span><span class="mi">475</span><span class="o">*</span><span class="n">scale</span><span class="p">)),</span><span class="mi">0</span><span class="p">:(</span><span class="nb">int</span><span class="p">(</span><span class="mi">30</span><span class="o">*</span><span class="n">scale</span><span class="p">))]</span><span class="o">=</span><span class="kc">True</span>
    <span class="n">sst</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mask</span><span class="p">[(</span><span class="nb">int</span><span class="p">(</span><span class="mi">540</span><span class="o">*</span><span class="n">scale</span><span class="p">)):,</span><span class="mi">0</span><span class="p">:(</span><span class="nb">int</span><span class="p">(</span><span class="mi">50</span><span class="o">*</span><span class="n">scale</span><span class="p">))]</span><span class="o">=</span><span class="kc">True</span>
    <span class="k">for</span> <span class="n">lat_in</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="mi">300</span><span class="o">*</span><span class="n">scale</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">lon_in</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">22</span><span class="o">*</span><span class="nb">int</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">resolution</span><span class="p">),</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">sst</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">lat_in</span><span class="p">,</span><span class="n">lon_in</span><span class="o">-</span><span class="p">(</span><span class="mi">360</span><span class="o">*</span><span class="nb">int</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">resolution</span><span class="p">))]</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
                <span class="n">sst</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">lat_in</span><span class="p">,</span><span class="n">lon_in</span><span class="p">]</span><span class="o">=</span><span class="kc">True</span>
    <span class="k">return</span><span class="p">(</span><span class="n">sst</span><span class="p">)</span>

<span class="c1"># Define an axes to contain the plot. In this case our axes covers</span>
<span class="c1">#  the whole figure</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span> <span class="c1"># Don&#39;t want surrounding x and y axis</span>

<span class="c1"># Lat and lon range (in rotated-pole coordinates) for plot</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">202</span><span class="p">,</span><span class="mi">180</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span><span class="mi">90</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>

<span class="c1"># Plot the SST</span>
<span class="n">sst</span> <span class="o">=</span> <span class="n">sst</span><span class="o">.</span><span class="n">regrid</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span><span class="n">iris</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">Linear</span><span class="p">())</span>
<span class="c1"># Strip out the duplicated data</span>
<span class="n">sst</span><span class="o">=</span><span class="n">strip_dups</span><span class="p">(</span><span class="n">sst</span><span class="p">,</span><span class="n">resolution</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
<span class="c1"># Re-map to highlight small differences</span>
<span class="n">s</span><span class="o">=</span><span class="n">sst</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>
<span class="n">sst</span><span class="o">.</span><span class="n">data</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">qcut</span><span class="p">(</span><span class="n">sst</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span><span class="mi">100</span><span class="p">,</span><span class="n">labels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                             <span class="n">duplicates</span><span class="o">=</span><span class="s1">&#39;drop&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">s</span><span class="p">),</span>
                        <span class="n">mask</span><span class="o">=</span><span class="n">sst</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>
<span class="c1"># Plot as a colour map</span>
<span class="n">lats</span> <span class="o">=</span> <span class="n">sst</span><span class="o">.</span><span class="n">coord</span><span class="p">(</span><span class="s1">&#39;latitude&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">points</span>
<span class="n">lons</span> <span class="o">=</span> <span class="n">sst</span><span class="o">.</span><span class="n">coord</span><span class="p">(</span><span class="s1">&#39;longitude&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">points</span>
<span class="n">sst_img</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolorfast</span><span class="p">(</span><span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">sst</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                        <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;RdYlBu_r&#39;</span><span class="p">,</span>
                        <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                        <span class="n">zorder</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

<span class="c1"># Draw lines of latitude and longitude</span>
<span class="k">for</span> <span class="n">offset</span> <span class="ow">in</span> <span class="p">(</span><span class="o">-</span><span class="mi">360</span><span class="p">,</span><span class="mi">0</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">lat</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span><span class="mi">95</span><span class="p">,</span><span class="mi">5</span><span class="p">):</span>
        <span class="n">lwd</span><span class="o">=</span><span class="mf">0.1</span>
        <span class="k">if</span> <span class="n">lat</span><span class="o">%</span><span class="mi">10</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="n">lwd</span><span class="o">=</span><span class="mf">0.2</span>
        <span class="k">if</span> <span class="n">lat</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="n">lwd</span><span class="o">=</span><span class="mi">1</span>
        <span class="n">x</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">y</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">lon</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span><span class="mi">181</span><span class="p">,</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">rp</span><span class="o">=</span><span class="n">iris</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">cartography</span><span class="o">.</span><span class="n">rotate_pole</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lon</span><span class="p">),</span>
                                                     <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lat</span><span class="p">),</span> <span class="mi">113</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
            <span class="n">nx</span><span class="o">=</span><span class="n">rp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">193</span><span class="o">+</span><span class="n">offset</span>
            <span class="k">if</span> <span class="n">nx</span><span class="o">&gt;</span><span class="mi">180</span><span class="p">:</span> <span class="n">nx</span> <span class="o">-=</span> <span class="mi">360</span>
            <span class="n">ny</span><span class="o">=</span><span class="n">rp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">nx</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">&lt;</span><span class="mi">10</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ny</span><span class="o">-</span><span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">&lt;</span><span class="mi">10</span><span class="p">)):</span>
                <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nx</span><span class="p">)</span>
                <span class="n">y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ny</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">Line2D</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">lwd</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
                                   <span class="n">zorder</span><span class="o">=</span><span class="mi">150</span><span class="p">))</span>
                <span class="n">x</span><span class="o">=</span><span class="p">[]</span>
                <span class="n">y</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">):</span>        
            <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">Line2D</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">lwd</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
                               <span class="n">zorder</span><span class="o">=</span><span class="mi">150</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">lon</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span><span class="mi">185</span><span class="p">,</span><span class="mi">5</span><span class="p">):</span>
        <span class="n">lwd</span><span class="o">=</span><span class="mf">0.1</span>
        <span class="k">if</span> <span class="n">lon</span><span class="o">%</span><span class="mi">10</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="n">lwd</span><span class="o">=</span><span class="mf">0.2</span>
        <span class="n">x</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">y</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">lat</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span><span class="mi">90</span><span class="p">,</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">rp</span><span class="o">=</span><span class="n">iris</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">cartography</span><span class="o">.</span><span class="n">rotate_pole</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lon</span><span class="p">),</span>
                                                     <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lat</span><span class="p">),</span> <span class="mi">113</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
            <span class="n">nx</span><span class="o">=</span><span class="n">rp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">193</span><span class="o">+</span><span class="n">offset</span>
            <span class="k">if</span> <span class="n">nx</span><span class="o">&gt;</span><span class="mi">180</span><span class="p">:</span> <span class="n">nx</span> <span class="o">-=</span> <span class="mi">360</span>
            <span class="n">ny</span><span class="o">=</span><span class="n">rp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">nx</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">&lt;</span><span class="mi">10</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ny</span><span class="o">-</span><span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">&lt;</span><span class="mi">10</span><span class="p">)):</span>
                <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nx</span><span class="p">)</span>
                <span class="n">y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ny</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">Line2D</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">lwd</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
                                   <span class="n">zorder</span><span class="o">=</span><span class="mi">150</span><span class="p">))</span>
                <span class="n">x</span><span class="o">=</span><span class="p">[]</span>
                <span class="n">y</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">):</span>        
            <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">Line2D</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">lwd</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
                               <span class="n">zorder</span><span class="o">=</span><span class="mi">150</span><span class="p">))</span>



<span class="c1"># Plot the sea ice</span>
<span class="n">icec</span> <span class="o">=</span> <span class="n">icec</span><span class="o">.</span><span class="n">regrid</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span><span class="n">iris</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">Nearest</span><span class="p">())</span>
<span class="n">icec_img</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolorfast</span><span class="p">(</span><span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">icec</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                         <span class="n">cmap</span><span class="o">=</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">ListedColormap</span><span class="p">(</span>
                                <span class="p">((</span><span class="mf">0.9</span><span class="p">,</span><span class="mf">0.9</span><span class="p">,</span><span class="mf">0.9</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
                                 <span class="p">(</span><span class="mf">0.9</span><span class="p">,</span><span class="mf">0.9</span><span class="p">,</span><span class="mf">0.9</span><span class="p">,</span><span class="mi">1</span><span class="p">))),</span>
                         <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                         <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                         <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                         <span class="n">zorder</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>

<span class="c1"># Plot the orography</span>
<span class="n">o_colors</span><span class="o">=</span><span class="p">[]</span>
<span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
    <span class="n">shade</span><span class="o">=</span><span class="mf">0.6</span><span class="o">+</span><span class="n">h</span><span class="o">/</span><span class="mi">300</span>
    <span class="n">o_colors</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">shade</span><span class="p">,</span><span class="n">shade</span><span class="p">,</span><span class="n">shade</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="n">orog</span> <span class="o">=</span> <span class="n">orog</span><span class="o">.</span><span class="n">regrid</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span><span class="n">iris</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">Linear</span><span class="p">())</span>
<span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">regrid</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span><span class="n">iris</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">Linear</span><span class="p">())</span>
<span class="n">orog</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="n">orog</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
<span class="n">orog</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">orog</span><span class="o">.</span><span class="n">data</span><span class="p">),</span>
                           <span class="n">mask</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">data</span><span class="o">&lt;</span><span class="mf">0.5</span><span class="p">,</span><span class="n">numpy</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">sst</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mask</span><span class="p">)))</span>
<span class="n">orog_img</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolorfast</span><span class="p">(</span><span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">orog</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                         <span class="n">cmap</span><span class="o">=</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">ListedColormap</span><span class="p">(</span><span class="n">o_colors</span><span class="p">),</span>
                         <span class="n">zorder</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>


<span class="c1"># Render the figure as a pdf</span>
<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;spilhaus_ostia_meto.pdf&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/Poster.png" alt="Logo"/>
            </a></p>
<h3><a href="../../index.html">Table of Contents</a></h3>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Ostia data in the Spilhaus projection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ISPD4.7/index.html">Observations coverage (ISPD4.7)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Stripes/20CR.html">Warming Stripes (20CRv3 version)</a></li>
<li class="toctree-l1"><a class="reference external" href="http://brohan.org/ML_GCM/presentations/index.html">Machine Learning GCM</a></li>
</ul>
<h3><a href="https://github.com/philip-brohan/Posters">Get the source code</a></h3>

<a href="https://github.com/philip-brohan/Posters"
           rel="nofollow">Github source repository</a>

<h3>Found a bug, or have a suggestion?</h3>

Please <a href="https://github.com/philip-brohan/Posters/issues/new">raise an issue</a>.
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../ISPD4.7/index.html" title="Observations coverage (ISPD4.7)"
             >next</a> |</li>
        <li class="right" >
          <a href="../../index.html" title="Eye-candy: Philip’s posters"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Posters</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Ostia data in the Spilhaus projection</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    </div>
  </body>
</html>